<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.5, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Building for a Target Machine (SICStus Prolog)</title>

<meta name="description" content="Building for a Target Machine (SICStus Prolog)">
<meta name="keywords" content="Building for a Target Machine (SICStus Prolog)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html#Top" rel="start" title="Top">
<link href="Predicate-Index.html#Predicate-Index" rel="index" title="Predicate Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Mixing-C-and-Prolog-Examples.html#Mixing-C-and-Prolog-Examples" rel="up" title="Mixing C and Prolog Examples">
<link href="Exceptions-from-C.html#Exceptions-from-C" rel="next" title="Exceptions from C">
<link href="Train-Example.html#Train-Example" rel="prev" title="Train Example">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
blockquote.smallindentedblock {margin-right: 0em; font-size: smaller}
blockquote.smallquotation {font-size: smaller}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
div.smalldisplay {margin-left: 3.2em}
div.smallexample {margin-left: 3.2em}
div.smalllisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: inherit; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: inherit; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


<link href="texinfo.css" rel="stylesheet" type="text/css">
</head>

<body lang="en">
<a name="Building-for-a-Target-Machine"></a>
<hr>
<a name="Building-for-a-Target-Machine-1"></a>
<h4 class="subsection">6.8.2 Building for a Target Machine</h4>

<p>The following example shows how to build an application with a
dynamically loaded foreign resource in such a way that it can be
deployed into an arbitrary folder on a target system that does not have
SICStus installed. The example is run on Linux but it would be very
similar on other platforms.
</p>
<p>The example consists of three source files, one top-level file
(<samp>main.pl</samp>) which in turn loads a module file (<samp>b.pl</samp>). The
latter also loads a foreign resource (<samp>b.c</samp>).
</p>
<p>The initial directory structure, and the contents of the source files
can be seen from the following transcript:
</p><div class="example">
<pre class="example">$ <kbd>find build/</kbd>
build/
build/myfiles
build/myfiles/main.pl
build/myfiles/b.pl
build/myfiles/b.c
$ <kbd>cat build/myfiles/main.pl</kbd>
:- module(main, [main/0]).

:- use_module(b,
              [b_foreign/1]).

main :-
  b_foreign(X),
  write(X), nl.

user:runtime_entry(start) :-
  main.

$ <kbd>cat build/myfiles/b.pl</kbd>
:- module(b, [b_foreign/1]).

foreign(b_foreign_c, b_foreign([-string])).

foreign_resource(b, [
        b_foreign_c]).

:- load_foreign_resource(b).

$ <kbd>cat build/myfiles/b.c</kbd>
#include &lt;sicstus/sicstus.h&gt;
/* b_glue.h is generated by splfr from the foreign/[2,3] facts. 
   Always include the glue header in your foreign resource code.
*/
#include &quot;b_glue.h&quot;

char const * SPCDECL b_foreign_c(void)
{
  return &quot;Hello World!&quot;;
}
</pre></div>

<p>The following transcript shows how the foreign resource and the SICStus
runtime executable is built:
</p>
<div class="example">
<pre class="example">$ <kbd>cd build/myfiles/</kbd>
$ <kbd>splfr b.pl b.c</kbd>
$ <kbd>cd ..</kbd>
$ <kbd>sicstus --nologo</kbd>
% optional step for embedding source info in saved state.
| ?- <kbd>set_prolog_flag(source_info, on).</kbd>
yes
% source_info
| ?- <kbd>compile('myfiles/main.pl').</kbd>
% compiling &hellip;/build/myfiles/main.pl...
%  module main imported into user
%  compiling &hellip;/build/myfiles/b.pl...
%   module b imported into main
%   loading foreign resource &hellip;/build/myfiles/b.so in module b
%  compiled &hellip;/build/myfiles/b.pl in module b, 0 msec 3104 bytes
% compiled &hellip;/build/myfiles/main.pl in module main, 0 msec 5344 bytes
yes
% source_info
| ?- <kbd>save_program('main.sav').</kbd>
% &hellip;/build/main.sav created in 20 msec
yes
% source_info
| ?- <kbd>halt.</kbd>
$ <kbd>spld '$SP_APP_DIR/main.sav' -o main.exe</kbd>
Created &quot;main.exe&quot;
</pre></div>
<p>(instead of creating <samp>main.exe</samp> you could use the generic runtime system
<samp>sprt.exe</samp> provided as part of the installation (see <a href="Generic-Runtime-Systems.html#Generic-Runtime-Systems">Generic Runtime Systems</a>)).
</p>
<p><strong>Please note</strong>: it is important that <samp>main.sav</samp> be saved to a
folder that is the &ldquo;root&rdquo; of the folder tree. The folder in which the
saved state is created (<samp>&hellip;/build/</samp> above) is treated
specially by <code>save_program/[1,2]</code> and by <code>restore/1</code>. This
special handling ensures that <code>myfiles/b.so</code> will be found relative
to the location of <samp>main.sav</samp> when <samp>main.sav</samp> is restored on
the target system. See <a href="Saving.html#Saving">Saving</a> for details.
</p>
<p>Next, the necessary runtime files must be copied from the SICStus
installation:
</p>
<div class="example">
<pre class="example">$ <kbd>mkdir -p sp-4.7.0/sicstus-4.7.0/bin</kbd>
$ <kbd>cp /usr/local/sicstus4.7.0/lib/libsprt4-7-0.so sp-4.7.0/</kbd>
$ <kbd>cp /usr/local/sicstus4.7.0/lib/sicstus-4.7.0/bin/sprt.sav \</kbd>
     <kbd>sp-4.7.0/sicstus-4.7.0/bin/sprt.sav</kbd>
</pre></div>

<p>The resulting folder contents can be seen by running the <code>find</code>
command:
</p>
<div class="example">
<pre class="example">$ <kbd>find . -print</kbd>
.
./sp-4.7.0
./sp-4.7.0/libsprt4-7-0.so
./sp-4.7.0/sicstus-4.7.0
./sp-4.7.0/sicstus-4.7.0/bin
./sp-4.7.0/sicstus-4.7.0/bin/sprt.sav
./myfiles
./myfiles/b.so
./myfiles/main.pl
./myfiles/b.pl
./myfiles/b.c
./main.sav
./main.exe
</pre></div>

<p>It is possible to run the program from its current location:
</p>
<div class="example">
<pre class="example">$ <kbd>./main.exe</kbd>
Hello World!
</pre></div>

<p>The folder <samp>build/myfiles/</samp> contains some files that do not need to
be present on the target machine, i.e. the source files. The following
transcript shows how a new folder, <code>target/</code>, is created that
contains only the files that need to be present on the target system.
</p>
<div class="example">
<pre class="example">$ <kbd>cd ..</kbd>
$ <kbd>mkdir target</kbd>
$ <kbd>mkdir target/myfiles</kbd>
$ <kbd>cp build/main.sav target</kbd>
$ <kbd>cp build/main.exe target</kbd>
$ <kbd>cp build/myfiles/b.so target/myfiles/</kbd>
$ <kbd>cp -R build/sp-4.7.0 target</kbd>
$ <kbd>find target/ -print</kbd>
target/
target/myfiles
target/myfiles/b.so
target/main.sav
target/main.exe
target/sp-4.7.0
target/sp-4.7.0/sicstus-4.7.0
target/sp-4.7.0/sicstus-4.7.0/bin
target/sp-4.7.0/sicstus-4.7.0/bin/sprt.sav
target/sp-4.7.0/libsprt4-7-0.so
$ <kbd>target/main.exe</kbd>
Hello World!
</pre></div>

<p>Note that <samp>target/myfiles/b.so</samp> was found since its location
relative the directory containing the saved state (<samp>main.sav</samp>) is
the same on the target system as on the build system.
</p>
<p>The folder <samp>target/</samp> can now be moved to some other system and
<samp>target/main.exe</samp> will not depend on any files of the build
machine.
</p>
<p>As a final example, the following transcripts show how the runtime
system can be debugged on the build machine. It is possible to do this
on the target system as well, if the necessary files are
made available. See <a href="Debugging-Runtime-Systems.html#Debugging-Runtime-Systems">Debugging Runtime Systems</a> for more information.
</p>
<p>First, the development system files and the license file must be made
available:
</p>
<div class="example">
<pre class="example">$ <kbd>mkdir sp-4.7.0/sicstus-4.7.0/library</kbd>
$ <kbd>cp /usr/local/sicstus4.7.0/lib/sicstus-4.7.0/library/SU_messages.po \</kbd>
     <kbd>sp-4.7.0/sicstus-4.7.0/library/</kbd>
$ <kbd>cp /usr/local/sicstus4.7.0/lib/sicstus-4.7.0/bin/spds.sav \</kbd>
     <kbd>sp-4.7.0/sicstus-4.7.0/bin/</kbd>
$ <kbd>cp /usr/local/sicstus4.7.0/lib/sicstus-4.7.0/library/license.pl \</kbd>
     <kbd>sp-4.7.0/sicstus-4.7.0/library/</kbd>
</pre></div>

<p>As before, the resulting folder contents can be seen by running the
<code>find</code> command:
</p>
<div class="example">
<pre class="example">$ <kbd>find . -print</kbd>
.
./sp-4.7.0
./sp-4.7.0/libsprt4-7-0.so
./sp-4.7.0/sicstus-4.7.0
./sp-4.7.0/sicstus-4.7.0/library
./sp-4.7.0/sicstus-4.7.0/library/SU_messages.po
./sp-4.7.0/sicstus-4.7.0/library/license.pl
./sp-4.7.0/sicstus-4.7.0/bin
./sp-4.7.0/sicstus-4.7.0/bin/spds.sav
./sp-4.7.0/sicstus-4.7.0/bin/sprt.sav
./myfiles
./myfiles/b.so
./myfiles/main.pl
./myfiles/b.pl
./myfiles/b.c
./main.sav
./main.exe
$
</pre></div>

<p>To tell the runtime system to start a development system. you can set the
<code>SP_USE_DEVSYS</code> environment variable as shown below. You could also
set <code>SP_ATTACH_SPIDER</code> and debug in the SICStus IDE
(see <a href="Debugging-Runtime-Systems.html#Debugging-Runtime-Systems">Debugging Runtime Systems</a>).
</p>
<div class="example">
<pre class="example">$ <kbd>SP_USE_DEVSYS=yes</kbd>
$ <kbd>export SP_USE_DEVSYS</kbd>
$ <kbd>./main.exe</kbd>
% The debugger will first creep -- showing everything (trace)
        1      1 Call: restore('$SP_APP_DIR/main.sav') ? <span class="key">RET</span>
% restoring &hellip;/build/main.sav...
% &hellip;/build/main.sav restored in 10 msec 5600 bytes
        1      1 Exit: restore('$SP_APP_DIR/main.sav') ? <span class="key">RET</span>
        2      1 Call: runtime_entry(start) ? <span class="key">RET</span>
in scope of a goal at line 12 in &hellip;/build/myfiles/main.pl
        3      2 Call: main:main ? <span class="key">RET</span>
in scope of a goal at line 7 in &hellip;/build/myfiles/main.pl
        4      3 Call: main:b_foreign(_2056) ? <span class="key">RET</span>
in scope of a goal at line 7 in &hellip;/build/myfiles/main.pl
        4      3 Exit: main:b_foreign('Hello World!') ? <kbd>v</kbd>
Local variables (hit RET to return to debugger)
X = 'Hello World!' ? <span class="key">RET</span>
in scope of a goal at line 7 in &hellip;/build/myfiles/main.pl
        4      3 Exit: main:b_foreign('Hello World!') ? <kbd>n</kbd>
Hello World!
$ 
</pre></div>

<p><strong>Please note</strong>: source info is available, since we used
<code>set_prolog_flag(source_info, on)</code> before we compiled <samp>main.pl</samp>
and created the saved state <code>main.sav</code>.
</p>

<hr>



<div class="logo">
<a href="https://sicstus.sics.se/">
<table><tr><td>&nbsp;</td></tr></table>
</a>
</div>
<div class="node">
<ul class="node">
<li><a href="index.html#Top">User's Manual</a>
<hr>
<li><a href="index.html#TOC">Table of Contents</a>
<li><a href="Exceptions-from-C.html#Exceptions-from-C" accesskey="n" rel="next">Next</a>
<li><a href="Train-Example.html#Train-Example" accesskey="p" rel="prev">Previous</a>
<li><a href="Mixing-C-and-Prolog-Examples.html#Mixing-C-and-Prolog-Examples" accesskey="u" rel="up">Up</a>
</ul>
</div>
<hr>
<a HREF="mailto:sicstus-support@ri.se?subject=Documentation%20feedback%20on%20html/sicstus/Building-for-a-Target-Machine.html&amp;body=Feedback%20on%20documentation%20node%20html/sicstus/Building-for-a-Target-Machine.html%20in%20User's%20Manual.">Send feedback on this subject.</a>
</body>
</html>
